<!DOCTYPE html>
<html lang="cn">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  <link rel="icon" href="/images/code.png">
  
  <title>3231note | INAB</title>
  
  <meta name="author" content="Xhmkggybz" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="COMP3231" />
  
  <meta name="description" content="UNSW COMP3231 23T1 notes">
<meta property="og:type" content="article">
<meta property="og:title" content="3231note">
<meta property="og:url" content="https://xhmkggybzwmz.github.io/2023/04/26/3231note/index.html">
<meta property="og:site_name" content="INAB">
<meta property="og:description" content="UNSW COMP3231 23T1 notes">
<meta property="og:locale">
<meta property="og:image" content="https://xhmkggybzwmz.github.io/2023/04/26/3231note/cover.png">
<meta property="article:published_time" content="2023-04-25T14:32:58.000Z">
<meta property="article:modified_time" content="2023-04-26T14:53:02.840Z">
<meta property="article:author" content="Xhmkggybz">
<meta property="article:tag" content="COMP3231">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xhmkggybzwmz.github.io/2023/04/26/3231note/cover.png">
  
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"></script>
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
    <link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"></script>
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('/images/Mei_header.jpg');
      }
    
    
      @media(min-width:768px) {
        body.custom-background {
          background-image: url('/images/bg.jpg');
        }
      }
    
  </style>
  
<meta name="generator" content="Hexo 6.3.0"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                        <li>
                                            
                                                <a href="/">
                                            
                                                
                                                    <i class="fa fa-home"></i>
                                                
                                                首页
                                            </a>
                                            
                                        </li>
                                    
                                        <li>
                                            
                                                <a href="/archives/">
                                            
                                                
                                                    <i class="fa fa-file"></i>
                                                
                                                档案馆
                                            </a>
                                            
                                        </li>
                                    
                                        <li>
                                            
                                                <a href="/friends/">
                                            
                                                
                                                    <i class="fa fa-paw"></i>
                                                
                                                好伙伴
                                            </a>
                                            
                                        </li>
                                    
                                        <li>
                                            
                                                <a>
                                            
                                                
                                                    <i class="fa fa-link"></i>
                                                
                                                链接
                                            </a>
                                            
                                                <ul class="sub-menu">
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://github.com/Candinya/Kratos-Rebirth">
                                                                
                                                                项目链接
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://space.bilibili.com/347171299">
                                                                
                                                                Bilibili
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://github.com/xhmkggybzwmz">
                                                                
                                                                github
                                                            </a>
                                                        </li>
                                                    
                                                </ul>
                                            
                                        </li>
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">INAB</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>INAB</h2> <br />
                        <span></span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="https://xhmkggybzwmz.github.io/2023/04/26/3231note/">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">3231note</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2023-04-25T14:32:58.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2023-04-26</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">Xhmkggybz</span>
                </li>
                
                    <li>
                        <i class="fa fa-edit"></i> 
                        
                        
                            ~41.33K
                        
                        字
                    </li>
                
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1682520782840"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
            
            <hr />
            <div itemprop="articleBody"><p>UNSW COMP3231 23T1 notes</p>
<span id="more"></span>
<h2 id="Lec-02-Processes-and-Threads"><a href="#Lec-02-Processes-and-Threads" class="headerlink" title="Lec 02 Processes and Threads"></a>Lec 02 Processes and Threads</h2><h3 id="Processes"><a href="#Processes" class="headerlink" title="Processes:"></a><strong>Processes:</strong></h3><p>• Also called a task or job</p>
<p>• Memory image of an individual program</p>
<p>• “Owner” of resources allocated for program execution</p>
<p>• Encompasses one or more threads </p>
<h3 id="Threads"><a href="#Threads" class="headerlink" title="Threads:"></a><strong>Threads:</strong></h3><p>• Unit of execution 执行命令的单位</p>
<p>• Can be traced</p>
<p>• list the sequence of instructions that execute</p>
<p>• Belongs to a process</p>
<p>• Executes within it.</p>
<p>One Process may contain one or more threads.</p>
<img src="/2023/04/26/3231note/1.png" class="" title="Threads">
<h3 id="Process-Termination"><a href="#Process-Termination" class="headerlink" title="Process Termination"></a><strong>Process Termination</strong></h3><p>Conditions which terminate processes</p>
<p>1. Normal exit (voluntary)</p>
<p>2. Error exit (voluntary)</p>
<p>3. Fatal error (involuntary)</p>
<p>4. Killed by another process (involuntary)</p>
<h3 id="Process-and-Thread-States"><a href="#Process-and-Thread-States" class="headerlink" title="Process and Thread States"></a><strong>Process and Thread States</strong></h3><p>Running</p>
<p>Blocked</p>
<p>Ready</p>
<h4 id="Running-→-Ready"><a href="#Running-→-Ready" class="headerlink" title="Running → Ready"></a><strong>Running → Ready</strong></h4><p>• Voluntary Yield()</p>
<p>• End of timeslice</p>
<h4 id="Running-→-Blocked"><a href="#Running-→-Blocked" class="headerlink" title="Running → Blocked"></a><strong>Running → Blocked</strong></h4><p>• Waiting for input</p>
<p>• File, network, </p>
<p>• Waiting for a timer (alarm signal)</p>
<p>• Waiting for a resource to become available</p>
<h3 id="Schedular"><a href="#Schedular" class="headerlink" title="Schedular"></a><strong>Schedular</strong></h3><p>Sometime called as <strong>dispatcher</strong>, it will choose a ready process to run.</p>
<p>BUT: It is inefficient to search through all processes</p>
<p>e.g: Ready Queue &amp; Blocked Queue</p>
<img src="/2023/04/26/3231note/2.png" class="" title="P21_lec02">


<h3 id="Thread-Model"><a href="#Thread-Model" class="headerlink" title="Thread Model"></a><strong>Thread Model</strong></h3><table>
<thead>
<tr>
<th>Per process items</th>
<th>Per thread items</th>
</tr>
</thead>
<tbody><tr>
<td><p>Address space</p><p>Global variables</p><p>Open files</p><p>Child processes</p><p>Pending alarms</p><p>Signals and signal handlers</p><p>Accounting information</p></td>
<td><p>Program counter</p><p>Registers</p><p>Stack (Each thread has its own stack)</p><p>State</p><p><img src="/2023/04/26/3231note/3.png" class="" title="Thread Model"></p></td>
</tr>
</tbody></table>
<p>Local variables are per thread (allocated on the stack)</p>
<p>Global variables are shared between all threads (Allocated in the data section)</p>
<p><strong>Concurrency control is an issue.</strong></p>
<p>Dynamically allocated memory can be global or local -&gt; Program defined</p>
<img src="/2023/04/26/3231note/4.png" class="" title="P29_lec02">

<h3 id="Thread-Usage"><a href="#Thread-Usage" class="headerlink" title="Thread Usage"></a><strong>Thread Usage</strong></h3><table>
<thead>
<tr>
<th><strong>Model 模型</strong></th>
<th><strong>Characteristics 特性</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Threads</td>
<td>Parallelism. Blocking system calls</td>
</tr>
<tr>
<td>Single-threaded Process</td>
<td>No parallelism, blocking system calls</td>
</tr>
<tr>
<td>Finite-state Machine</td>
<td>Parallelism, nonblocking system calls, interrupts</td>
</tr>
</tbody></table>
<h3 id="Summary-in-Threads"><a href="#Summary-in-Threads" class="headerlink" title="Summary in Threads"></a><strong>Summary in Threads</strong></h3><ol>
<li><strong>Simpler to program than a state machine</strong></li>
<li><strong>Less resources associated with threads than multiple complete processes</strong><ol>
<li><strong>Cheaper to create and destroy</strong></li>
<li><strong>Share resources (especially memory) between them</strong></li>
</ol>
</li>
<li><strong>Performance: Threads waiting for IO can be overlapped with computing threads</strong><ol>
<li><strong>If all threads are compute bound(被运算速度限制), then there is no performance improvement (on uniprocessor)</strong></li>
</ol>
</li>
<li><strong>Threads can take advantage of the parallelism available on machines with more than one CPU (multiprocessor)</strong></li>
</ol>
<h2 id="Lec-03-Concurrency-and-Synchronisation"><a href="#Lec-03-Concurrency-and-Synchronisation" class="headerlink" title="Lec 03 Concurrency and Synchronisation"></a>Lec 03 Concurrency and Synchronisation</h2><h3 id="Concurrency-Example"><a href="#Concurrency-Example" class="headerlink" title="Concurrency Example:"></a><strong>Concurrency Example:</strong></h3><p>Trying to modify a global variable in two threads</p>
<img src="/2023/04/26/3231note/5.png" class="" title="Concurrency Example">

<p><strong>The reason for why there is in-kernel concurrency for single-threaded processes:</strong></p>
<ol>
<li>Multi-tasking</li>
<li>Interrupt handling</li>
<li>Device drivers</li>
<li>System calls</li>
<li>Resource sharing</li>
</ol>
<img src="/2023/04/26/3231note/6.png" class="" title="P6_lec03">
<h3 id="Critical-Region-and-how-to-identify"><a href="#Critical-Region-and-how-to-identify" class="headerlink" title="Critical Region and how to identify"></a><strong>Critical Region and how to identify</strong></h3><p>A critical region is a region of code where shared resources are accessed.</p>
<p><strong>We can control access to the shared resource by controlling access to the code that accesses the resource.</strong></p>
<p>Uncoordinated entry to the critical region results in a race condition (<strong>Concurrency Occurs</strong>)</p>
<p><strong>HOW TO IDENTIFY:</strong></p>
<p>Critical regions are the regions of code that </p>
<ol>
<li>access a shared resource,</li>
<li>and correctness <strong>relies on the shared resource not being concurrently modified</strong> by another thread&#x2F;process&#x2F;entity.\</li>
</ol>
<p><strong>HOW TO PREVENT:</strong></p>
<img src="/2023/04/26/3231note/7.png" class="" title="Critical Region">
<h3 id="Critical-Regions-Solutions"><a href="#Critical-Regions-Solutions" class="headerlink" title="Critical Regions Solutions"></a><strong>Critical Regions Solutions</strong></h3><p>Conditions required of any solution to the critical region problem:</p>
<ol>
<li>Mutual exclusion:<ol>
<li>No two processes&#x2F;threads in the critical region at the same time</li>
</ol>
</li>
<li>No assumptions made about speeds or numbers of CPUs</li>
<li>No process running outside its critical region may block another process</li>
<li>No process waited forever to enter its critical region (<strong>Bounded</strong>)</li>
</ol>
<h3 id="Mutual-exclusion-by-taking-turns"><a href="#Mutual-exclusion-by-taking-turns" class="headerlink" title="Mutual exclusion by taking turns"></a><strong>Mutual exclusion by taking turns</strong></h3><p>Works for solving concurrency issues: <strong>strict alternation -&gt; each process takes turns</strong></p>
<p>Cons (缺点)</p>
<ol>
<li>Busy waiting</li>
<li>Process must wait its turn even while the other process is doing something else<ol>
<li>In a multiple processes condition, must wait for everyone to have a turn<ol>
<li>Does not guarantee progress if a process no longer needs a turn</li>
</ol>
</li>
<li>Poor solution when processes require the critical section at different rates</li>
</ol>
</li>
</ol>
<h3 id="Mutual-Exclusion-by-disabling-interrupts"><a href="#Mutual-Exclusion-by-disabling-interrupts" class="headerlink" title="Mutual Exclusion by disabling interrupts"></a><strong>Mutual Exclusion by disabling interrupts</strong></h3><p>How it works:</p>
<p>Before entering a critical region, disable interrupts.</p>
<p>After leaving the critical region, enable interrupts.</p>
<p><strong>Cons:</strong></p>
<ol>
<li>Only available in the kernel</li>
<li>Delays everybody else, even with no contention<ol>
<li>Slows the interrupt response time</li>
</ol>
</li>
<li>Does not work on a multiprocessor</li>
</ol>
<h3 id="Hardware-Support-for-mutual-exclusion"><a href="#Hardware-Support-for-mutual-exclusion" class="headerlink" title="Hardware Support for mutual exclusion"></a><strong>Hardware Support for mutual exclusion</strong></h3><p><strong>Test and Set instruction</strong></p>
<p>•Can be used to implement lock variables correctly</p>
<p>•Load the value of the lock</p>
<p>•If lock &#x3D;&#x3D; 0</p>
<p>•Set the lock to 1</p>
<p>•Return the result 0 -&gt; we acquire the lock</p>
<p>•if lock &#x3D;&#x3D; 1</p>
<p>• return 1 -&gt; another thread&#x2F;process has the lock</p>
<p>•Hardware guarantees that the instruction executes atomically -&gt; not be interrupt</p>
<img src="/2023/04/26/3231note/8.png" class="" title="Test And Set">

<p><strong>Pros:</strong></p>
<ol>
<li>Simple (easy to verify work or not)</li>
<li>Available at user level<ol>
<li>Work with any number of processors</li>
<li>To implement any number of lock variables</li>
</ol>
</li>
</ol>
<p><strong>Cons:</strong></p>
<ol>
<li>Busy waits (also named as a spin lock)<ol>
<li>Consumes CPU</li>
<li>Starvation is possible when a process leaves its critical section and more than one process is waiting.</li>
</ol>
</li>
</ol>
<h3 id="Tackling-the-busy-wait-problem"><a href="#Tackling-the-busy-wait-problem" class="headerlink" title="Tackling the busy-wait problem:"></a><strong>Tackling the busy-wait problem:</strong></h3><p>Sleep&#x2F;Wakeup</p>
<ol>
<li>When the process is waiting for an event, it calls sleep to block, instead of busy waiting.</li>
<li>The event happens, the event generator (another process) calls wakeup to unblock the sleeping process.</li>
<li>Waking a ready&#x2F;running process has no effect.</li>
</ol>
<h3 id="Producer-Consumer-Problem-bounded-buffer-problem"><a href="#Producer-Consumer-Problem-bounded-buffer-problem" class="headerlink" title="Producer-Consumer Problem(bounded buffer problem)"></a><strong>Producer-Consumer Problem(bounded buffer problem)</strong></h3><p>Description: producer produces data items and store items in a buffer.</p>
<p>Consumer takes the items out of the buffer and consumes them.</p>
<img src="/2023/04/26/3231note/9.png" class="" title="Producer Consumer">
<h4 id="Issues"><a href="#Issues" class="headerlink" title="Issues:"></a><strong>Issues:</strong></h4><p>Producer</p>
<p>Should sleep when the buffer is full.</p>
<p>And wakeup when there is empty space in the buffer.</p>
<p>The consumer can call wakeup when it consumes the first entry of the full buffer.</p>
<p>Consumer</p>
<p>Should sleep when the buffer is empty.</p>
<p>And wakeup when there are items available.</p>
<p>Producer can call wakeup when it adds the first item to the buffer.</p>
<h3 id="Semaphores"><a href="#Semaphores" class="headerlink" title="Semaphores"></a><strong>Semaphores</strong></h3><p>Two primitives that are more powerful than simple sleep and wakeup alone.</p>
<p>• P(): proberen, from Dutch to test.</p>
<p>• V(): verhogen, from Dutch to increment.</p>
<p>• Also called <strong>wait &amp; signal</strong>, <strong>down &amp; up</strong>.</p>
<p>How it works:</p>
<p>If a resource is not available, the corresponding semaphore blocks any process <strong>waiting</strong> for the resource.</p>
<p>Blocked processes are put into a process queue maintained by the semaphore (avoids busy waiting!)</p>
<p>When a process releases a resource, it <strong>signals</strong> this by means of the semaphore.</p>
<p>Signaling resumes a blocked process if there is any.</p>
<p><strong>Wait (P)</strong> and <strong>signal (V)</strong> operations <strong>cannot be interrupted</strong>.</p>
<p>Complex coordination can be implemented by multiple semaphores.</p>
<img src="/2023/04/26/3231note/10.png" class="" title="Semaphore">
<img src="/2023/04/26/3231note/11.png" class="" title="Semaphore">

<p><strong>The initial count determines how many waits can progress before blocking and requiring a signal.</strong></p>
<h3 id="Producer-Consumer-problem-with-semaphores"><a href="#Producer-Consumer-problem-with-semaphores" class="headerlink" title="Producer Consumer problem with semaphores:"></a><strong>Producer Consumer problem with semaphores:</strong></h3><img src="/2023/04/26/3231note/12.png" class="" title="Define Semaphore">

<img src="/2023/04/26/3231note/13.png" class="" title="Define Semaphore">
<h3 id="Summarising-Semaphores"><a href="#Summarising-Semaphores" class="headerlink" title="Summarising Semaphores"></a><strong>Summarising Semaphores</strong></h3><p>Semaphores can be used to solve a variety of concurrency problems.</p>
<p>However, programming with then can be error-prone:</p>
<p>E.g. <strong>must signal for every wait</strong></p>
<p>To many or too few signals or waits, or signals and waits in the wrong order, can have bad results.</p>
<h3 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a><strong>Monitor</strong></h3><p>A higher level synchronisation primitive.</p>
<p>Programming language construct</p>
<p><strong>IDEA:</strong></p>
<p>A set of procedures&#x2F;variables&#x2F;data types are grouped in a special module:monitor.</p>
<p>Variables and data types can only be accessed from <strong>within the monitor</strong>.</p>
<p><strong>Only one process&#x2F;thread can be in the monitor at any one time.</strong></p>
<p>Mutual exclusion is implemented by the complier.</p>
<img src="/2023/04/26/3231note/14.png" class="" title="P44_lec03">
<p>When a thread calls a monitor procedure that has a thread already inside, it will be in the entry queue and will sleep until the current thread exits the monitor.</p>
<img src="/2023/04/26/3231note/15.png" class="" title="Monitor">
<h3 id="Condition-Variable"><a href="#Condition-Variable" class="headerlink" title="Condition Variable"></a><strong>Condition Variable</strong></h3><p>To allow a process to wait within the monitor, we need to declare a condition variable.</p>
<p>Condition variable can only be used with the operations <strong>wait</strong> and <strong>signal</strong>.</p>
<p><strong>x.wait()</strong></p>
<p>Means that the process invoking this operation is suspended until another process invokes.</p>
<p>Another thread can enter the monitor while original is suspended.</p>
<p><strong>x.signal()</strong></p>
<p>this operation resumes <strong>only one</strong> suspended process.</p>
<p>If no process is suspended, then this operation has no effect.</p>
<img src="/2023/04/26/3231note/16.png" class="" title="P49_lec03">

<p>How to achieve producer-consumer problem with monitors is in <strong>P50 lec03</strong>.</p>
<h3 id="Synchronisation-Primitives-in-OS-x2F-161"><a href="#Synchronisation-Primitives-in-OS-x2F-161" class="headerlink" title="Synchronisation Primitives in OS&#x2F;161"></a><strong>Synchronisation Primitives in OS&#x2F;161</strong></h3><h4 id="Locks"><a href="#Locks" class="headerlink" title="Locks"></a><strong>Locks</strong></h4><img src="/2023/04/26/3231note/17.png" class="" title="P53_lec03">
<h4 id="Semaphores-1"><a href="#Semaphores-1" class="headerlink" title="Semaphores"></a><strong>Semaphores</strong></h4><img src="/2023/04/26/3231note/18.png" class="" title="P55_lec03">

<p><strong>Wait (P)</strong> &#x2F; <strong>signal (V)</strong></p>
<h4 id="Condition-Variables"><a href="#Condition-Variables" class="headerlink" title="Condition Variables"></a><strong>Condition Variables</strong></h4><img src="/2023/04/26/3231note/19.png" class="" title="P56_lec03">

<p>Note: All three variants must hold the lock passed in.</p>
<h5 id="Condition-Variables-and-Bounded-Buffers"><a href="#Condition-Variables-and-Bounded-Buffers" class="headerlink" title="Condition Variables and Bounded Buffers"></a><strong>Condition Variables and Bounded Buffers</strong></h5><img src="/2023/04/26/3231note/20.png" class="" title="P57_lec03">

<p>cv_wait() will release the lock before block the process</p>
<h5 id="Producer-consumer-solution-with-condition-variable"><a href="#Producer-consumer-solution-with-condition-variable" class="headerlink" title="Producer-consumer solution with condition variable"></a><strong>Producer-consumer solution with condition variable</strong></h5><img src="/2023/04/26/3231note/21.png" class="" title="P58_lec03">

<h3 id="Dining-Philosophers"><a href="#Dining-Philosophers" class="headerlink" title="Dining Philosophers"></a><strong>Dining Philosophers</strong></h3><p>哲学家就餐问题是一个经典的计算机科学同步问题，由Edsger Dijkstra在1965年提出。问题描述了五位哲学家围坐在圆桌旁的情景，他们在思考问题和吃饭之间交替。圆桌中间有一碗意面，每两位哲学家之间有一根筷子。每位哲学家需要两根筷子才能吃饭。哲学家们不能交谈，只能思考或吃饭。</p>
<p>问题在于设计一个协议，使得每位哲学家都能够在需要时使用两根筷子吃饭，而不会出现死锁（即所有哲学家都在等待筷子，无法继续吃饭）或者饥饿（即某位哲学家长时间无法获得筷子）的情况。</p>
<p>以下是一个可能的解决方案：</p>
<p>我们可以为每根筷子分配一个编号（例如，1到5），并为每位哲学家分配一个编号。每位哲学家在需要吃饭时，先尝试拿起编号较低的筷子，然后尝试拿起编号较高的筷子。当哲学家同时拥有两根筷子时，他们可以开始吃饭。吃完饭后，他们将筷子放回原位，然后继续思考。</p>
<p>这种方法可以避免死锁，因为至少有一位哲学家（具有最低编号筷子的哲学家）可以拿起两根筷子并开始吃饭。其他哲学家则需要等待筷子被放回。虽然这种方法可能导致某些哲学家等待时间较长，但可以确保所有哲学家都有机会吃饭，避免饥饿现象。</p>
<h3 id="Reader-and-Writer-Problem"><a href="#Reader-and-Writer-Problem" class="headerlink" title="Reader and Writer Problem"></a><strong>Reader and Writer Problem</strong></h3><p>读者-写者问题是一个经典的计算机科学并发控制问题，用于描述多个进程在访问共享资源时需要进行同步的场景。在这个问题中，有一些读者进程和写者进程。读者进程只读取共享资源，而写者进程可以修改共享资源。问题的挑战在于设计一个同步协议，以允许多个读者进程同时访问共享资源，但在写者进程访问资源时，确保其他进程（读者和写者）无法访问资源。</p>
<p>以下是一个可能的解决方案：</p>
<p>我们可以使用互斥量（mutex）和信号量（semaphore）来实现这个协议。在这个解决方案中，我们需要一个互斥量来保护对共享资源的访问计数器，以及一个信号量来控制对共享资源的访问。</p>
<p>读者进程：</p>
<ol>
<li>请求互斥量以修改访问计数器。</li>
<li>将访问计数器加1。如果这是第一个读者进程，请求信号量以阻止写者进程访问共享资源。</li>
<li>释放互斥量。</li>
<li>访问共享资源。</li>
<li>请求互斥量以修改访问计数器。</li>
<li>将访问计数器减1。如果这是最后一个读者进程，释放信号量以允许写者进程访问共享资源。</li>
<li>释放互斥量。</li>
</ol>
<p>写者进程：</p>
<ol>
<li>请求信号量以阻止其他进程访问共享资源。</li>
<li>访问共享资源。</li>
<li>释放信号量以允许其他进程访问共享资源。</li>
</ol>
<p>这个解决方案允许多个读者进程同时访问共享资源，但当有写者进程需要访问资源时，它们将等待所有当前的读者进程完成。同样，在写者进程访问共享资源时，其他读者和写者进程将被阻止。这种方法可以确保在写者进程访问资源时，没有其他进程可以访问共享资源。</p>
<h2 id="Lec04-DeadLock"><a href="#Lec04-DeadLock" class="headerlink" title="Lec04 DeadLock"></a>Lec04 DeadLock</h2><h3 id="DeadLock-amp-Resources"><a href="#DeadLock-amp-Resources" class="headerlink" title="DeadLock &amp; Resources"></a><strong>DeadLock &amp; Resources</strong></h3><p>Deadlocks occurs when</p>
<ol>
<li>Processes are granted exclusive access to devices&#x2F;locks&#x2F;tables..</li>
<li>We refer to these entities generally as resources.</li>
</ol>
<p>Deadlock: definition</p>
<p><strong>A set of processes is deadlocked if each process in the set is waiting for an event that only another process in the set can cause.</strong></p>
<p>In the deadlock situation, no process can</p>
<ol>
<li>Run</li>
<li>Release resources</li>
<li>Be awakened</li>
</ol>
<h3 id="Four-conditions-for-deadlock"><a href="#Four-conditions-for-deadlock" class="headerlink" title="Four conditions for deadlock"></a><strong>Four conditions for deadlock</strong></h3><ol>
<li>Mutual exclusion condition<ol>
<li>Each resource assigned to 1 process or is available</li>
</ol>
</li>
<li>Hold and wait condition<ol>
<li>Process holding resources can request additional</li>
</ol>
</li>
<li>No preemption condition<ol>
<li>Previously granted resources cannot be forcibly taken away</li>
</ol>
</li>
<li>Circular wait	condition<ol>
<li>Must be a circular chain of 2 or more processes</li>
<li>Each is waiting for resource held by next member of the chain</li>
</ol>
</li>
</ol>
<h3 id="Deadlock-avoidance"><a href="#Deadlock-avoidance" class="headerlink" title="Deadlock avoidance"></a><strong>Deadlock avoidance</strong></h3><ol>
<li>Just ignore the problem altogether</li>
<li>Prevention 预防<ol>
<li>Negating on of the four necessary conditions</li>
</ol>
</li>
<li>Detection and recovery</li>
<li>Dynamic avoidance<ol>
<li>Careful resource allocation</li>
</ol>
</li>
</ol>
<h4 id="Method-1-Ostrich-Algorithm"><a href="#Method-1-Ostrich-Algorithm" class="headerlink" title="Method 1: Ostrich Algorithm"></a><strong>Method 1: Ostrich Algorithm</strong></h4><p>Pretend there is no problem</p>
<p>Reasonable if</p>
<ol>
<li>Deadlocks occur very rarely</li>
<li>Cost of prevention is high</li>
</ol>
<p>UNIX and Windows takes this approach for some of the more complex resource relationships they manage</p>
<p>It’s a trade off between</p>
<ol>
<li>Convenience (engineering approach)</li>
<li>Correctness (mathematical approach)</li>
</ol>
<h4 id="Method-2-Deadlock-prevention"><a href="#Method-2-Deadlock-prevention" class="headerlink" title="Method 2: Deadlock prevention"></a><strong>Method 2: Deadlock prevention</strong></h4><p>Resource allocation rules prevent deadlock by prevent one of the four conditions required for deadlock from occurring:</p>
<ol>
<li>Mutual exclusion</li>
<li>Hold and wait</li>
<li>No preemption</li>
<li>Circular Wait</li>
</ol>
<h5 id="Attacking-the-Mutual-Exclusion-Condition-Not-feasible"><a href="#Attacking-the-Mutual-Exclusion-Condition-Not-feasible" class="headerlink" title="Attacking the Mutual Exclusion Condition (Not feasible)"></a><strong>Attacking the Mutual Exclusion Condition (Not feasible)</strong></h5><p>Not feasible in general</p>
<p>Some devices&#x2F;resources are intrinsically(本质上) not sharable.</p>
<h5 id="Attacking-the-hold-and-wait-condition-request-resources-initially"><a href="#Attacking-the-hold-and-wait-condition-request-resources-initially" class="headerlink" title="Attacking the hold and wait condition (request resources initially)"></a><strong>Attacking the hold and wait condition (request resources initially)</strong></h5><p>Require processes to <strong>request resources before starting</strong></p>
<p>A process never has to wait for what it needs</p>
<p><strong>Issues</strong>:</p>
<ol>
<li>May not know required resources at start of run</li>
</ol>
<p>Which means not always possible</p>
<ol>
<li>Also ties up resources other processes could be using</li>
</ol>
<p><strong>Variations:</strong></p>
<ol>
<li>Process must give up all resources if it would block holding a resource</li>
<li>Then request all immediately need</li>
<li>Prone(倾向于) to livelock</li>
</ol>
<h5 id="Attacking-the-No-Preemption-condition-无优先权条件-take-resources-away"><a href="#Attacking-the-No-Preemption-condition-无优先权条件-take-resources-away" class="headerlink" title="Attacking the No Preemption condition(无优先权条件)(take resources away)"></a><strong>Attacking the No Preemption condition(无优先权条件)(take resources away)</strong></h5><p><strong>Not a viable option</strong></p>
<h5 id="Attacking-the-circular-wait-condition-Order-resources"><a href="#Attacking-the-circular-wait-condition-Order-resources" class="headerlink" title="Attacking the circular wait condition (Order resources)"></a><strong>Attacking the circular wait condition (Order resources)</strong></h5><p><strong><em>Numerically ordered resources</em> (Resources ordering is a common technique)</strong></p>
<h4 id="Method-3-Detection-and-recovery"><a href="#Method-3-Detection-and-recovery" class="headerlink" title="Method 3: Detection and recovery"></a><strong>Method 3: Detection and recovery</strong></h4><p>Need a method to determine if a system is deadlocked.</p>
<p>Assuming deadlocked is detected, we need a method of recovery to restore progress to the system.</p>
<h5 id="Strategy"><a href="#Strategy" class="headerlink" title="Strategy:"></a><strong>Strategy:</strong></h5><p>Note the resource ownership and requests</p>
<p>A cycle can be found within the graph, which denotes a deadlock</p>
<h5 id="Detection-with-Multiple-Resources-of-Each-Type"><a href="#Detection-with-Multiple-Resources-of-Each-Type" class="headerlink" title="Detection with Multiple Resources of Each Type"></a><strong>Detection with Multiple Resources of Each Type</strong></h5><img src="/2023/04/26/3231note/22.png" class="" title="P28_lec04">

<p><strong>Sum of current resource allocation + resources available &#x3D; resources that exist</strong></p>
<img src="/2023/04/26/3231note/23.png" class="" title="Detection">
<h6 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h6><ol>
<li>Look for an unmarked process <strong>Pi</strong>, for which the i-th row of R is less than or equal to A.</li>
<li>If found, add the i-th row of <strong>C</strong> to <strong>A</strong>, and mark <strong>Pi</strong>, then go back to step 1.</li>
<li>If no such process exists, terminate.</li>
</ol>
<p><strong>The remaining processes are deadlocked.</strong></p>
<h5 id="Recovery-from-Deadlock"><a href="#Recovery-from-Deadlock" class="headerlink" title="Recovery from Deadlock"></a><strong>Recovery from Deadlock</strong></h5><p><strong>Recovery through preemption</strong></p>
<p>• take a resource from some other process</p>
<p>• depends on nature of the resource</p>
<p><strong>Recovery through rollback</strong></p>
<p>• checkpoint a process periodically</p>
<p>• use this saved state </p>
<p>• restart the process if it is found deadlocked</p>
<p>• No guarantee is won’t deadlock again</p>
<p><strong>Recovery through killing processes</strong></p>
<p>• crudest but simplest way to break a deadlock</p>
<p>• kill one of the processes in the deadlock cycle</p>
<p>• the other processes get its resources </p>
<p>• choose process that can be rerun from the beginning</p>
<h4 id="Method-4-Deadlock-Avoidance"><a href="#Method-4-Deadlock-Avoidance" class="headerlink" title="Method 4: Deadlock Avoidance"></a><strong>Method 4: Deadlock Avoidance</strong></h4><p>Only enough information is available in advance, we can avoid a deadlock.</p>
<ol>
<li>Maximum number of each resource required</li>
</ol>
<img src="/2023/04/26/3231note/24.png" class="" title="P47_lec04">

<h5 id="Safe-and-Unsafe-states"><a href="#Safe-and-Unsafe-states" class="headerlink" title="Safe and Unsafe states"></a><strong>Safe and Unsafe states</strong></h5><p><strong>A state is safe if</strong></p>
<p>• The system is not deadlocked</p>
<p>• There exists a scheduling order that results in every process running </p>
<p>to completion, even if they all request their maximum resources </p>
<p>immediately</p>
<p><strong>Unsafe states are not necessarily deadlocked</strong></p>
<p>• With a lucky sequence, all processes may complete </p>
<p>• However, we <strong>cannot guarantee</strong> that they will complete </p>
<p>(not deadlock)</p>
<p>• <strong>Safe states guarantee we will eventually complete all processes</strong></p>
<p>•Deadlock avoidance algorithm</p>
<p>• Only grant requests that result in safe states</p>
<h3 id="LiveLock"><a href="#LiveLock" class="headerlink" title="LiveLock"></a><strong>LiveLock</strong></h3><p>Livelocked processes are not blocked, change state regularly, but never make progress</p>
<img src="/2023/04/26/3231note/25.png" class="" title="P19_lec04">
<h3 id="Bankers-Algorithm"><a href="#Bankers-Algorithm" class="headerlink" title="Bankers Algorithm"></a><strong>Bankers Algorithm</strong></h3><p>Modelled on a Banker with Customers</p>
<p>• The banker has a limited amount of money to loan customers</p>
<p>• Limited number of resources</p>
<p>• Each customer can borrow money up to the customer’s credit limit</p>
<p>• Maximum number of resources required</p>
<p>Basic Idea</p>
<p>• Keep the bank in a safe state </p>
<p>• So all customers are happy even if they all request to borrow up to their </p>
<p>credit limit at the same time.</p>
<p>• Customers wishing to borrow such that the bank would enter an unsafe state must wait until somebody else repays their loan such that the the </p>
<p>transaction becomes safe</p>
<h3 id="Starvation"><a href="#Starvation" class="headerlink" title="Starvation"></a><strong>Starvation</strong></h3><p>A process never receives the resource it is waiting for, despite the resource (repeatedly) becoming free, the resource is always allocated to another waiting process</p>
<p><strong>One Solution: First come, first server</strong></p>
<h2 id="Lec05-Processes-and-Threads-Implementation"><a href="#Lec05-Processes-and-Threads-Implementation" class="headerlink" title="Lec05 Processes and Threads Implementation"></a>Lec05 Processes and Threads Implementation</h2><h3 id="MIPS-Registers"><a href="#MIPS-Registers" class="headerlink" title="MIPS Registers"></a><strong>MIPS Registers</strong></h3><p>User-mode accessible registers</p>
<p>• 32 general purpose registers</p>
<p>• r0 hardwired to zero</p>
<p>• r31 the link register for jump-and-link </p>
<p>(JAL) instruction</p>
<p>HI&#x2F;LO </p>
<p>• 2 * 32-bits for multiply and divide</p>
<p>PC </p>
<p>• Not directly visible</p>
<p>• Modified implicitly by jump and branch instructions</p>
<h3 id="Branching-and-Jumping"><a href="#Branching-and-Jumping" class="headerlink" title="Branching and Jumping"></a><strong>Branching and Jumping</strong></h3><p>Branching and jumping have a branch delay slot</p>
<p>• <strong>The instruction following a branch or jump is always executed prior to destination of jump</strong></p>
<h3 id="Process"><a href="#Process" class="headerlink" title="Process"></a><strong>Process</strong></h3><h4 id="Memory-allocation"><a href="#Memory-allocation" class="headerlink" title="Memory allocation"></a><strong>Memory allocation</strong></h4><p>Minimally consist of three segments</p>
<p>• Text</p>
<p>• contains the code (instructions)</p>
<p>• Data</p>
<p>• Global variables</p>
<p>• Stack</p>
<p>• Activation records of procedure&#x2F;function&#x2F;method</p>
<p>• Local variables </p>
<p>Note:</p>
<p>• data can dynamically grow up</p>
<p>• E.g., malloc()-ing</p>
<p>• The stack can dynamically grow down</p>
<p>• E.g., increasing function call depth or recursion</p>
<img src="/2023/04/26/3231note/26.png" class="" title="P23_lec05"> P23 lec05

<h4 id="Mode-distinguish"><a href="#Mode-distinguish" class="headerlink" title="Mode distinguish"></a><strong>Mode distinguish</strong></h4><p><strong>User-mode</strong></p>
<p>• Processes (programs) scheduled by the kernel</p>
<p>• Isolated from each other</p>
<p>• <strong>No concurrency issues between each other</strong></p>
<p><strong>System-calls transition into and return from the kernel</strong></p>
<p><strong>Kernel-mode</strong></p>
<p>• Nearly all activities still associated with a process</p>
<p>• Kernel memory shared between all processes</p>
<p>• Concurrency issues exist between processes concurrently executing in a system call</p>
<h3 id="User-level-Threads"><a href="#User-level-Threads" class="headerlink" title="User-level Threads"></a><strong>User-level Threads</strong></h3><img src="/2023/04/26/3231note/27.png" class="" title="P32_lec05">

<p><strong>Implementation at user-level</strong></p>
<p>• User-level Thread Control Block (TCB), ready queue, blocked queue, and dispatcher</p>
<p>• Kernel has no knowledge of the threads (it only sees a single process)</p>
<p>• If a thread blocks waiting for a resource held by another thread inside </p>
<p>the same process, its state is saved and the dispatcher switches to another ready thread</p>
<p>• Thread management (create, exit, yield, wait) are implemented in a runtime support library</p>
<h4 id="Pros"><a href="#Pros" class="headerlink" title="Pros"></a><strong>Pros</strong></h4><p>• Thread management and switching <strong>at user level is much faster than doing it in kernel level</strong></p>
<p>• No need to trap (take syscall exception) into kernel and back to switch</p>
<p>• Dispatcher algorithm can be tuned to the application</p>
<p>• E.g. use priorities</p>
<p>• Can be implemented on any OS (thread or non-thread aware)</p>
<p>• Can easily support massive numbers of threads on a per-application </p>
<p>basis</p>
<p>• Use normal application virtual memory</p>
<p>• Kernel memory more constrained. Difficult to efficiently support wildly differing numbers of threads for different applications</p>
<h4 id="Cons"><a href="#Cons" class="headerlink" title="Cons"></a><strong>Cons</strong></h4><p>• Threads have to yield() manually (<strong>no timer interrupt delivery to user level</strong>)</p>
<p>• <strong>Co-operative multithreading</strong></p>
<p>• A single poorly design&#x2F;implemented thread can monopolise the available CPU time</p>
<p>• There are work-arounds (e.g. a timer signal per second to enable pre-emptive multithreading), they are course grain and a kludge.</p>
<p>• Does not take advantage of multiple CPUs (in reality, we still have a single threaded process as far as the kernel is concerned)</p>
<p>• If a thread makes a blocking system call (or takes a page fault), the process (and all the internal threads) blocks</p>
<p>• Can’t overlap I&#x2F;O with computation</p>
<h3 id="Kernel-provided-Threads"><a href="#Kernel-provided-Threads" class="headerlink" title="Kernel-provided Threads"></a><strong>Kernel-provided Threads</strong></h3><img src="/2023/04/26/3231note/28.png" class="" title="P38_lec05">

<p><strong>Threads are implemented by the kernel</strong></p>
<p>• TCBs (thread control block) are stored in the kernel</p>
<p>• A subset of information in a traditional PCB (process control block)</p>
<p>• The subset related to execution context</p>
<p>• TCBs have a PCB associated with them</p>
<p>• Resources associated with the group of threads (the process)</p>
<p>• Thread management calls are implemented as system calls</p>
<p>• E.g. create, wait, exit</p>
<h4 id="Cons-1"><a href="#Cons-1" class="headerlink" title="Cons"></a><strong>Cons</strong></h4><p>• Thread creation and destruction, and blocking and unblocking threads requires kernel entry and exit.</p>
<p>• More expensive than user-level equivalent</p>
<h4 id="Pros-1"><a href="#Pros-1" class="headerlink" title="Pros"></a><strong>Pros</strong></h4><p>• Preemptive multithreading</p>
<p>• Parallelism</p>
<p>• Can overlap blocking I&#x2F;O with computation</p>
<p>• <strong>Can take advantage of a multiprocessor</strong></p>
<h3 id="Context-Switch"><a href="#Context-Switch" class="headerlink" title="Context Switch"></a><strong>Context Switch</strong></h3><p><strong>Context Switch is what the lowest level of OS does when an interrupt occurs.</strong></p>
<p>A context switch can refer to</p>
<p>• A switch between threads</p>
<p>• Involving saving and restoring of state associated with a thread</p>
<p>• A switch between processes</p>
<p>• Involving the above, plus extra state associated with a process. </p>
<p>• E.g. memory maps</p>
<h4 id="Context-Switch-Occurrence"><a href="#Context-Switch-Occurrence" class="headerlink" title="Context Switch Occurrence"></a><strong>Context Switch Occurrence</strong></h4><p>A switch between process&#x2F;threads can happen any time the OS is invoked</p>
<p>• On a system call</p>
<p>• Mandatory if system call blocks or on exit();</p>
<p>• On an exception</p>
<p>• Mandatory if offender is killed</p>
<p>• On an interrupt</p>
<p>• Triggering a dispatch is the main purpose of the timer interrupt</p>
<p><strong>A thread switch can happen between any two instructions</strong></p>
<p>Note <strong>instructions do not equal program statements</strong></p>
<h3 id="Context-Switch-Addition"><a href="#Context-Switch-Addition" class="headerlink" title="Context Switch Addition"></a><strong>Context Switch Addition</strong></h3><ul>
<li>Context switch must be transparent for processes&#x2F;threads</li>
</ul>
<p>• When dispatched again, process&#x2F;thread should not notice that something else was running in the meantime (except for elapsed time)</p>
<ol>
<li>OS must save all state that affects the thread</li>
</ol>
<p>• This state is called the process&#x2F;thread context</p>
<p>• Switching between process&#x2F;threads consequently </p>
<p>results in a context switch.</p>
<h2 id="Lec06-Syscalls"><a href="#Lec06-Syscalls" class="headerlink" title="Lec06 Syscalls"></a>Lec06 Syscalls</h2><h3 id="Syscall-Definition"><a href="#Syscall-Definition" class="headerlink" title="Syscall Definition"></a><strong>Syscall Definition</strong></h3><p>Can be viewed as special function calls</p>
<p>• Provides for a controlled entry into the kernel</p>
<p>• While in kernel, they perform a privileged operation</p>
<p>• Returns to original caller with the result</p>
<p>The system call interface represents the abstract machine provided by the operating system.</p>
<h3 id="CPU-Computation-Model"><a href="#CPU-Computation-Model" class="headerlink" title="CPU Computation Model"></a><strong>CPU Computation Model</strong></h3><p>The fetch-execute cycle</p>
<p>• Load memory contents from address in program counter (PC)</p>
<p>• The instruction</p>
<p>• Execute the instruction</p>
<p>• Increment PC</p>
<p>• Repeat</p>
<img src="/2023/04/26/3231note/29.png" class="" title="P12_lec06">
<h3 id="Privileged-mode-operation"><a href="#Privileged-mode-operation" class="headerlink" title="Privileged-mode operation"></a><strong>Privileged-mode operation</strong></h3><p>To protect operating system execution, two or more CPU modes of operation exist</p>
<p>• Privileged mode (system-, kernel-mode)</p>
<p>• <strong>All instructions and registers are available</strong></p>
<p>• User-mode</p>
<p>• Uses ‘safe’ subset of the instruction set </p>
<p>• Only affects the state of the application itself </p>
<p>• They cannot be used to uncontrollably interfere with OS</p>
<p>• <strong>Only ‘safe’ registers are accessible</strong></p>
<p>The accessibility of addresses within an address space changes depending on operating mode</p>
<p>• To protect kernel code and data</p>
<p>• Note: The exact memory ranges are usually configurable, and vary between CPU architectures and&#x2F;or operating systems.</p>
<img src="/2023/04/26/3231note/30.png" class="" title="P16_lec06">

<p><strong>System call mechanism securely transfers from user execution to kernel execution and back.</strong></p>
<h3 id="System-call-mechanism-overview"><a href="#System-call-mechanism-overview" class="headerlink" title="System call mechanism overview"></a><strong>System call mechanism overview</strong></h3><p>• Processor mode</p>
<p>• Switched from user-mode to kernel-mode</p>
<p>• Switched back when returning to user mode</p>
<p>• Stack Pointer (SP)</p>
<p>• User-level SP is saved and a kernel SP is initialised</p>
<p>• User-level SP restored when returning to user-mode</p>
<p>• Program Counter (PC)</p>
<p>• User-level PC is saved and PC set to kernel entry point</p>
<p>• User-level PC restored when returning to user-level</p>
<p>• <strong>Kernel entry via the designated entry point must be strictly enforced</strong></p>
<p>•Registers</p>
<p>• Set at user-level to indicate system call type and its arguments</p>
<p>• A convention between applications and the kernel</p>
<p>• Some registers are preserved at user-level or kernel-level in order to restart user-level execution</p>
<p>• Depends on language calling convention etc.</p>
<p>• Result of system call placed in registers when returning to user-level</p>
<p>• Another convention</p>
<p>We need system calls because function calls do not:</p>
<ol>
<li>Change from user to kernel mode&#x2F;back again</li>
<li>Restrict possible entry points to secure locations</li>
</ol>
<h3 id="Coprocessor-0-CP0"><a href="#Coprocessor-0-CP0" class="headerlink" title="Coprocessor 0 (CP0)"></a><strong>Coprocessor 0 (CP0)</strong></h3><p>The processor control registers are located in CP0</p>
<ol>
<li>Exception&#x2F;Interrupt management registers</li>
<li>Translation management registers</li>
</ol>
<h4 id="Exception-management"><a href="#Exception-management" class="headerlink" title="Exception management"></a><strong>Exception management</strong></h4><img src="/2023/04/26/3231note/31.png" class="" title="P26_lec06">
<h4 id="C0-status"><a href="#C0-status" class="headerlink" title="C0_status"></a><strong>C0_status</strong></h4><p>We only focus on 0-15 bits</p>
<img src="/2023/04/26/3231note/32.png" class="" title="P28_lec06">
<h4 id="·c0-cause"><a href="#·c0-cause" class="headerlink" title="·c0_cause"></a><strong>·c0_cause</strong></h4><p>The 2<sup>nd</sup>-6<sup>th</sup> bit is for ExcCode -&gt; The code number of the exception taken</p>
<h4 id="C0-epc"><a href="#C0-epc" class="headerlink" title="C0_epc"></a><strong>C0_epc</strong></h4><p>The <strong>Exception Program Counter</strong></p>
<p>• Points to address of where to restart execution after handling the exception or interrupt</p>
<h3 id="Hardware-Exception-handling"><a href="#Hardware-Exception-handling" class="headerlink" title="Hardware Exception handling"></a><strong>Hardware Exception handling</strong></h3><p>Basic situation: Assume an interrupt occurred as the previous instruction completed &amp; We are in user mode with interrupts enabled.</p>
<p>Steps:</p>
<ol>
<li>Instruction address at which to restart after the interrupt is transferred to EPC</li>
<li>Interrupts disabled and previous state shifted along<ol>
<li>What stored in IEc&#x2F;KUc is now in IEp&#x2F;KUp</li>
<li><strong>Kernel mode is set</strong>, and previous state shifted along<ol>
<li>What stored in IEp&#x2F;KUp (before 2 a) executed) is now in IEo&#x2F;KUo</li>
</ol>
</li>
</ol>
</li>
<li>Code for the exception placed in Cause -&gt; ExcCode in c0_cause is now 0 (0 is the code for interrupt)</li>
<li>Address of general exception vector placed in PC</li>
<li>CPU now running in kernel mode at the address in PC, with interrupt disabled<ol>
<li>All information required to<ol>
<li>Find out what caused the exception</li>
<li>Restart after exception handling</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>Is in coprocessor registers</p>
<ol>
<li>(Ignore how the OS handles the exception)</li>
<li>Load the contents of EPC</li>
<li>Store the EPC back in the PC</li>
<li>In the branch delay slot (happens when we jump back to the PC&#x2F;user mode), execute a restore from exception instruction -&gt; move back KU&#x2F;IE</li>
<li>Now back in the same state we were when the exception happened</li>
</ol>
<h3 id="MIPS-System-Calls"><a href="#MIPS-System-Calls" class="headerlink" title="MIPS System Calls"></a><strong>MIPS System Calls</strong></h3><p>• System calls are invoked via a syscall instruction.</p>
<p>• The syscall instruction causes an exception and transfers control to the general exception handler</p>
<p>• A convention (an agreement between the kernel and </p>
<p>applications) is required as to how user-level software </p>
<p>indicates </p>
<p>• Which system call is required </p>
<p>• Where its arguments are</p>
<p>• Where the result should go</p>
<h3 id="OS-x2F-161-Systems-Calls"><a href="#OS-x2F-161-Systems-Calls" class="headerlink" title="OS&#x2F;161 Systems Calls"></a><strong>OS&#x2F;161 Systems Calls</strong></h3><p>OS&#x2F;161 uses the following conventions:</p>
<p>• Arguments are passed and returned via the normal C function calling convention</p>
<p>• Additionally</p>
<p>• Reg v0 contains the system call number</p>
<p>• <strong>On return, reg a3 contains</strong></p>
<p><strong>• 0: if success, v0 contains successful result</strong> </p>
<p>• not 0: if failure, v0 has the errno. </p>
<p>• v0 stored in errno</p>
<p>• -1 returned in v0</p>
<h3 id="Summary-of-System-Call-in-User-Mode"><a href="#Summary-of-System-Call-in-User-Mode" class="headerlink" title="Summary of System Call in User Mode"></a><strong>Summary of System Call in User Mode</strong></h3><p>• From the caller’s perspective, the read() system call behaves like a normal function call</p>
<p>• It preserves the calling convention of the language</p>
<p>•However, the actual function implements its own convention by agreement with the kernel</p>
<p>• Our OS&#x2F;161 example assumes the kernel preserves appropriate registers(s0-s8, sp, gp, ra).</p>
<p>•Most languages have similar libraries that interface with the operating system.</p>
<h3 id="System-Calls-–-Kernel-Side"><a href="#System-Calls-–-Kernel-Side" class="headerlink" title="System Calls – Kernel Side"></a><strong>System Calls – Kernel Side</strong></h3><p>• Things left to do</p>
<p>• Change to kernel stack</p>
<p>• Preserve registers by saving to memory (on the kernel stack)</p>
<p>• Leave saved registers somewhere accessible to</p>
<p>• Read arguments</p>
<p>• Store return values</p>
<p>• Do the “read()”</p>
<p>• Restore registers</p>
<p>• Switch back to user stack</p>
<p>• Return to application</p>
<h2 id="Lec07-Computer-Hardware-Review"><a href="#Lec07-Computer-Hardware-Review" class="headerlink" title="Lec07 Computer Hardware Review"></a>Lec07 Computer Hardware Review</h2><h3 id="Memory-Hierarchy"><a href="#Memory-Hierarchy" class="headerlink" title="Memory Hierarchy"></a><strong>Memory Hierarchy</strong></h3><img src="/2023/04/26/3231note/33.png" class="" title="P4 lec07">
<h3 id="Cashing"><a href="#Cashing" class="headerlink" title="Cashing"></a><strong>Cashing</strong></h3><p>•Given two-levels of data storage: small and fast, versus large and slow,</p>
<p>• Can speed access to slower storage by using intermediate-speed storage as a cache.</p>
<h4 id="CPU-cache"><a href="#CPU-cache" class="headerlink" title="CPU cache"></a><strong>CPU cache</strong></h4><img src="/2023/04/26/3231note/34.png" class="" title="P7 lec07">

<p>• CPU cache is fast memory placed between the CPU and main memory </p>
<p>• 1 to a few cycles access time compared to RAM access time of tens – hundreds of cycles</p>
<p>• <strong>Holds recently used data or instructions to save memory accesses.</strong></p>
<p>• <strong>Matches slow RAM access time to CPU speed if high hit rate</strong></p>
<p>• Is hardware maintained and (mostly) transparent to software</p>
<p>• Sizes range from few kB to tens of MB.</p>
<p>• Usually a hierarchy of caches (2–5 levels), on- and off-chip</p>
<h4 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a><strong>Performance</strong></h4><p>The performance depends on the hit rate in the first level.</p>
<h4 id="Effective-Access-Time"><a href="#Effective-Access-Time" class="headerlink" title="Effective Access Time"></a><strong>Effective Access Time</strong></h4><img src="/2023/04/26/3231note/35.png" class="" title="P9 lec07">
<h4 id="Avoid-Waiting-for-Disk-Access"><a href="#Avoid-Waiting-for-Disk-Access" class="headerlink" title="Avoid Waiting for Disk Access"></a><strong>Avoid Waiting for Disk Access</strong></h4><p>• Keep a subset of the disk’s data in main memory</p>
<ol>
<li>OS uses main memory as a cache of disk contents</li>
</ol>
<h4 id="Avoid-Waiting-for-Internet-Access"><a href="#Avoid-Waiting-for-Internet-Access" class="headerlink" title="Avoid Waiting for Internet Access"></a><strong>Avoid Waiting for Internet Access</strong></h4><p>• Keep a subset of the Internet’s data on disk</p>
<ol>
<li>Application uses disk as a cache of the internet</li>
</ol>
<h2 id="Lec08-File-Management"><a href="#Lec08-File-Management" class="headerlink" title="Lec08 File Management"></a>Lec08 File Management</h2><h3 id="File-Names"><a href="#File-Names" class="headerlink" title="File Names"></a><strong>File Names</strong></h3><p>File system must provide a convenient naming scheme</p>
<p>• Textual Names</p>
<p>• May have restrictions</p>
<p>• Only certain characters</p>
<p>• E.g. no ‘&#x2F;’ characters</p>
<p>• Limited length</p>
<p>• Only certain format </p>
<p>• E.g DOS, 8 + 3</p>
<p>• Case (in)sensitive</p>
<p>• Names may obey conventions (.c files for C files)</p>
<p>• Interpreted by tools (e.g. UNIX)</p>
<p>• Interpreted by operating system (e.g. Windows “con:”)</p>
<h3 id="File-Structure"><a href="#File-Structure" class="headerlink" title="File Structure"></a><strong>File Structure</strong></h3><p>• Sequence of Bytes</p>
<p>• OS considers a file to be unstructured</p>
<p>• Applications can impose their own structure</p>
<p>• Used by UNIX, Windows, most modern OSes</p>
<img src="/2023/04/26/3231note/36.png" class="" title="P9 lec08">P9 lec08
<h3 id="File-Types"><a href="#File-Types" class="headerlink" title="File Types"></a><strong>File Types</strong></h3><p>• Regular files</p>
<p>•Directories</p>
<p>•Device Files</p>
<p>–May be divided into</p>
<p>•Character Devices – stream of bytes</p>
<p>•Block Devices</p>
<p>•Some systems distinguish between regular file types</p>
<p>–ASCII text files, binary files</p>
<h3 id="File-Access-Types-Patterns"><a href="#File-Access-Types-Patterns" class="headerlink" title="File Access Types (Patterns)"></a><strong>File Access Types (Patterns)</strong></h3><p>•Sequential access 顺序读写</p>
<p>–read all bytes&#x2F;records from the beginning</p>
<p>–cannot jump around, could rewind or back up</p>
<p>–<strong>convenient when medium was magnetic tape</strong></p>
<p>•Random access 随机读写</p>
<p>–bytes&#x2F;records read in any order</p>
<p>–<strong>essential for data base systems</strong></p>
<p>–read can be …</p>
<p>•move file pointer (seek), then read or</p>
<p>–lseek(location,…);read(…)</p>
<p>•each read specifies the file pointer</p>
<p>–read(location,…)</p>
<h3 id="Typical-File-Operations"><a href="#Typical-File-Operations" class="headerlink" title="Typical File Operations"></a><strong>Typical File Operations</strong></h3><ol>
<li>Create</li>
<li>Delete</li>
<li>Open</li>
<li>Close</li>
<li>Read</li>
<li>Write</li>
<li>Append</li>
<li>Seek</li>
<li>Get attributes</li>
<li>Set Attribute</li>
<li>Rename</li>
</ol>
<h3 id="Criteria-for-File-Organization"><a href="#Criteria-for-File-Organization" class="headerlink" title="Criteria for File Organization"></a><strong>Criteria for File Organization</strong></h3><p>Things to consider when designing file layout</p>
<p>•Rapid access</p>
<p>–Needed when accessing a single record</p>
<p>–Not needed for batch mode</p>
<p>•read from start to finish</p>
<p>•Ease of update</p>
<p>–File on CD-ROM will not be updated, so this is not a concern</p>
<p>•Economy of storage</p>
<p>–Should be minimum redundancy in the data</p>
<p>–Redundancy can be used to speed access such as an index</p>
<h3 id="File-Directories"><a href="#File-Directories" class="headerlink" title="File Directories"></a><strong>File Directories</strong></h3><p>•Provide <strong>mapping between file names and the files themselves</strong></p>
<p>•Contain information about files</p>
<p>–Attributes</p>
<p>–Location</p>
<p>–Ownership</p>
<p>•<strong>Directory itself is a file owned by the operating system</strong></p>
<h3 id="Hierarchical-Tree-Structured-Directory"><a href="#Hierarchical-Tree-Structured-Directory" class="headerlink" title="Hierarchical (Tree Structured) Directory"></a><strong>Hierarchical (Tree Structured) Directory</strong></h3><p>•Files can be located by following a path from the root, or master, directory down various branches</p>
<p>–This is the absolute pathname for the file</p>
<p>•<strong>Can have several files with the same file name as long as they have unique path names(同一路径下的文件名不得相等)</strong></p>
<h3 id="Relative-and-Absolute-Pathnames"><a href="#Relative-and-Absolute-Pathnames" class="headerlink" title="Relative and Absolute Pathnames"></a><strong>Relative and Absolute Pathnames</strong></h3><p>•Absolute pathname</p>
<p>–A path specified <strong>from the root of the file system to the file</strong></p>
<p>A Relative pathname</p>
<p>–A pathname specified from the cwd (current working directory)</p>
<h3 id="Typical-Directory-Operations"><a href="#Typical-Directory-Operations" class="headerlink" title="Typical Directory Operations"></a><strong>Typical Directory Operations</strong></h3><ol>
<li>Create</li>
<li>Delete</li>
<li>Opendir</li>
<li>Closedir</li>
<li>Readdir</li>
<li>Rename</li>
<li>Link</li>
<li>Unlink</li>
</ol>
<h3 id="Nice-Properties-of-UNIX-naming"><a href="#Nice-Properties-of-UNIX-naming" class="headerlink" title="Nice Properties of UNIX naming"></a><strong>Nice Properties of UNIX naming</strong></h3><p>•Simple, regular format</p>
<p>–Names referring to different servers, objects, etc., <strong>have the same syntax</strong>.</p>
<p>•Regular tools can be used where specialised tools would be otherwise be needed.</p>
<p>•Location independent</p>
<p>–Objects can be distributed or migrated, and continue with the same names</p>
<h3 id="Access-Rights"><a href="#Access-Rights" class="headerlink" title="Access Rights"></a><strong>Access Rights</strong></h3><p>In multiuser system, we need to consider the issue of the access rights.</p>
<p>Different kinds of Access Rights:</p>
<ol>
<li>None<ol>
<li>User <strong>may not know the existence</strong> of the file</li>
<li>User is <strong>not allowed to read the directory</strong> that includes the file</li>
</ol>
</li>
<li>Knowledge<ol>
<li>User can <strong>only determine that the file exists and who its owner is</strong></li>
</ol>
</li>
<li>Execution<ol>
<li>The user can load and execute a program <strong>but cannot copy it</strong></li>
</ol>
</li>
<li>Reading<ol>
<li>The user can <strong>read the file for any purpose,</strong> including copying and execution</li>
</ol>
</li>
<li>Appending<ol>
<li>The user can add data to the file but cannot modify or delete any of the file’s contents</li>
</ol>
</li>
<li>Updating<ol>
<li>The user can <strong>modify, delete, and add</strong> to the file’s data. This includes <strong>creating the file, rewriting it, and removing all or part</strong> of the data</li>
</ol>
</li>
<li>Changing protection<ol>
<li>User can <strong>change access rights</strong> granted to other users</li>
</ol>
</li>
<li>Deletion<ol>
<li>User can delete the file</li>
</ol>
</li>
<li>Owners<ol>
<li><strong>Has all rights previously listed</strong></li>
<li>May grant rights to others using the following classes of users<ol>
<li>•Specific user</li>
<li>•User groups</li>
<li>•All for public files</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="Simultaneous-Access"><a href="#Simultaneous-Access" class="headerlink" title="Simultaneous Access"></a><strong>Simultaneous Access</strong></h3><p>In multiuser system, we need to consider the issue of the simultaneous access.</p>
<p>•Most OSes provide mechanisms for users to manage concurrent access to files</p>
<p>–Example: flock(), lockf(), system calls</p>
<p>•Typically</p>
<p>–User may <strong>lock entire file</strong> when it is to be updated</p>
<p>–User may <strong>lock the individual records</strong> (i.e. ranges) during the update</p>
<p>•<strong>Mutual exclusion and deadlock are issues</strong> for shared access</p>
<h2 id="Lec09-File-System-Internals"><a href="#Lec09-File-System-Internals" class="headerlink" title="Lec09 File System Internals"></a>Lec09 File System Internals</h2><h3 id="UNIX-Storage-Stack"><a href="#UNIX-Storage-Stack" class="headerlink" title="UNIX Storage Stack"></a><strong>UNIX Storage Stack</strong></h3><p>From lower to Higher:</p>
<ol>
<li>Hard disk platters:<ol>
<li>Tracks</li>
<li>Sectors</li>
</ol>
</li>
<li>Disk controller<ol>
<li>Hides disk geometry, bad sectors</li>
<li>Exposes linear sequence of blocks(disk’s interface)</li>
</ol>
</li>
<li>Device driver<ol>
<li>Hides device-specific protocol</li>
<li>Exposes block-device interface</li>
</ol>
</li>
<li>Disk scheduler&#x2F;buffer cache -&gt; Optimisations<ol>
<li>Keep recently accessed disk blocks in memory</li>
<li>Schedule disk accesses from multiple processes for performance and fairness</li>
</ol>
</li>
<li>File System<ol>
<li>Hides physical location of data on the disk</li>
<li>Exposes:<ol>
<li>Directory hierarchy 目录的层次结构</li>
<li>Symbolic file names</li>
<li>Random-access files</li>
<li>Protrction</li>
</ol>
</li>
</ol>
</li>
<li>Virtual File System (VFS)<ol>
<li>Unified interface to multiple File systems</li>
</ol>
</li>
<li>Open File Table (OF table)&#x2F;File Descriptor Table (FD table)<ol>
<li>Keep track of files opened by user-level processes</li>
<li>Matches syscall interface to VFS interface</li>
</ol>
</li>
</ol>
<img src="/2023/04/26/3231note/37.png" class="" title="P10 lec09">
<h3 id="Difference-between-some-FS"><a href="#Difference-between-some-FS" class="headerlink" title="Difference between some FS"></a><strong>Difference between some FS</strong></h3><p><strong>Different physical nature of storage devices</strong></p>
<p>– Ext3 is optimised for magnetic disks</p>
<p>– JFFS2 is optimised for flash memory devices</p>
<p>– ISO9660 is optimised for CDROM</p>
<p><strong>Different storage capacities</strong></p>
<p>– FAT16 does not support drives &gt;2GB</p>
<p>– FAT32 becomes inefficient on drives &gt;32GB</p>
<p>– ZFS, Btrfs is designed to scale to multi-TB disk arrays</p>
<p><strong>Different CPU and memory requirements</strong></p>
<p>– FAT16 is not suitable for modern PCs but is a good fit for many embedded devices</p>
<p><strong>Proprietary standards</strong></p>
<p>– NTFS may be a nice FS, but its specification is closed</p>
<h3 id="Property-of-hard-disk"><a href="#Property-of-hard-disk" class="headerlink" title="Property of hard disk"></a><strong>Property of hard disk</strong></h3><p>– Seek time</p>
<p>• ~15ms worst case</p>
<p>– Rotational delay</p>
<p>• 8ms worst case for 7200rpm drive</p>
<p>– For comparison, disk-to-buffer transfer speed of a modern drive is ~10µs per 4K block</p>
<p>Conclusion: <strong>keep blocks that are likely to be accessed together close to each other</strong></p>
<h3 id="Implementing-a-file-system"><a href="#Implementing-a-file-system" class="headerlink" title="Implementing a file system"></a><strong>Implementing a file system</strong></h3><h4 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a><strong>Requirements</strong></h4><p>The FS must map symbolic file names into a collection of block addresses.</p>
<p>The FS must keep track of</p>
<p>– which blocks belong to which files.</p>
<p>– in what order the blocks form the file</p>
<p>– which blocks are free for allocation</p>
<p><strong>Given a logical region of a file, the FS must track the corresponding block(s) on disk.</strong></p>
<img src="/2023/04/26/3231note/38.png" class="" title="P16 lec09">
<h4 id="File-Allocation-Methods"><a href="#File-Allocation-Methods" class="headerlink" title="File Allocation Methods"></a><strong>File Allocation Methods</strong></h4><h5 id="Contiguous-Allocation"><a href="#Contiguous-Allocation" class="headerlink" title="Contiguous Allocation"></a><strong>Contiguous Allocation</strong></h5><p>✔ <strong>Easy bookkeeping</strong> (need to keep track of the starting block and length of the file)</p>
<p>✔ Increases performance for <strong>sequential operations</strong></p>
<p>✗ <strong>Need the maximum size for the file</strong> at the time of creation</p>
<p>✗ As files are deleted, free space becomes divided into many small chunks (<strong>external fragmentation</strong>)</p>
<p>Example: ISO 9660 (CDROM)</p>
<img src="/2023/04/26/3231note/39.png" class="" title="P18 lec09">

<h5 id="Dynamic-Allocation-Strategies"><a href="#Dynamic-Allocation-Strategies" class="headerlink" title="Dynamic Allocation Strategies"></a><strong>Dynamic Allocation Strategies</strong></h5><p>– Disk space allocated in portions as needed</p>
<p>– Allocation occurs in fixed-size blocks</p>
<p>✔ <strong>No external fragmentation</strong></p>
<p>✔ Does not require pre-allocating disk space</p>
<p>✗ Partially filled blocks (<strong>internal fragmentation</strong>)</p>
<p>✗ File blocks are scattered across the disk</p>
<p>✗ Complex metadata management (maintain the collection of blocks </p>
<p>for each file)</p>
<img src="/2023/04/26/3231note/40.png" class="" title="P19 lec09">

<p>Examples come after:</p>
<ol>
<li><a href="#_dynamic_allocation_:">Linked list allocation</a></li>
<li><a href="#_dynamic_allocation:_file">File Allocation Table (FAT)</a></li>
<li><a href="#_dynamical_allocation:_inode-based">Inode-based FS structure</a></li>
</ol>
<h3 id="External-and-Internal-fragmentation"><a href="#External-and-Internal-fragmentation" class="headerlink" title="External and Internal fragmentation"></a><strong>External and Internal fragmentation</strong></h3><h4 id="External-fragmentation"><a href="#External-fragmentation" class="headerlink" title="External fragmentation"></a><strong>External fragmentation</strong></h4><p>– The space wasted <strong>external to the allocated memory regions</strong></p>
<p>– Memory space exists to satisfy a request but it is unusable as it is not contiguous</p>
<h4 id="Internal-fragmentation"><a href="#Internal-fragmentation" class="headerlink" title="Internal fragmentation"></a><strong>Internal fragmentation</strong></h4><p>– The space wasted internal to the allocated memory regions</p>
<p>– <strong>Allocated memory may be slightly larger than requested memory</strong>; this <strong>size difference is wasted memory internal to a partition</strong></p>
<h4 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a><strong>Conclusion</strong></h4><p>Internal fragmentation is inside the allocated memory blocks</p>
<p>External fragmentation is between two allocated memory blocks</p>
<h3 id="Dynamic-allocation-Linked-list-allocation"><a href="#Dynamic-allocation-Linked-list-allocation" class="headerlink" title="Dynamic allocation : Linked list allocation"></a><a name="_dynamic_allocation_:"></a><strong>Dynamic allocation : Linked list allocation</strong></h3><p>Each block contains the block number of the next block in the chain. Free blocks are also linked in a chain.</p>
<p>✔ Only single metadata entry per file</p>
<p>✔ <strong>Best for sequentially accessed files</strong></p>
<p>✗ <strong>Poor for random access</strong></p>
<p>✗ Blocks end up scattered across the disk due to free list <strong>eventually being randomised</strong></p>
<img src="/2023/04/26/3231note/41.png" class="" title="P21 lec09">
<h3 id="Dynamic-Allocation-File-allocation-Table-FAT"><a href="#Dynamic-Allocation-File-allocation-Table-FAT" class="headerlink" title="Dynamic Allocation: File allocation Table (FAT)"></a><a name="_dynamic_allocation:_file"></a><strong>Dynamic Allocation: File allocation Table (FAT)</strong></h3><p>• Keep a map of the entire FS in a separate table</p>
<p>– A table entry contains the number of the next block of the file</p>
<p>– The last block in a file and empty blocks are marked using reserved values</p>
<p>• The table is stored on the disk and is replicated in memory</p>
<p>• <strong>Random access is fast</strong> (following the in-memory list)</p>
<p>Issues:</p>
<p>Requires a lot of memory for large disks</p>
<h4 id="File-allocation-table-disk-layout"><a href="#File-allocation-table-disk-layout" class="headerlink" title="File allocation table disk layout"></a><strong>File allocation table disk layout</strong></h4><img src="/2023/04/26/3231note/42.png" class="" title="P25 lec09">
<h3 id="Dynamical-Allocation-inode-based-FS-structure"><a href="#Dynamical-Allocation-inode-based-FS-structure" class="headerlink" title="Dynamical Allocation: inode-based FS structure"></a><a name="_dynamical_allocation:_inode-based"></a><strong>Dynamical Allocation: inode-based FS structure</strong></h3><p>Idea: separate table (index-node or i-node) for each file.</p>
<p>– Only keep table for open files in memory</p>
<p>– <strong>Fast random access</strong></p>
<p><strong>The most popular FS structure today</strong></p>
<img src="/2023/04/26/3231note/43.png" class="" title="P26 lec09">
<h4 id="Issues-1"><a href="#Issues-1" class="headerlink" title="Issues:"></a><strong>Issues:</strong></h4><ol>
<li>i-nodes occupy one or several disk areas</li>
<li>i-nodes are <strong>allocated dynamically</strong>, hence <strong>free-space management</strong> is required for i-nodes<ol>
<li>– Use fixed-size i-nodes to simplify dynamic allocation</li>
<li>– Reserve the last i-node entry for a pointer (a block number) to an extension i-node</li>
</ol>
</li>
</ol>
<img src="/2023/04/26/3231note/44.png" class="" title="P28 lec09">

<ol>
<li>Free-space management<ol>
<li>Approach 1: Linked list of free blocks in free blocks on disk</li>
<li>Keep bitmaps of free blocks and free i-nodes on disk</li>
</ol>
</li>
</ol>
<img src="/2023/04/26/3231note/45.png" class="" title="P29 lec09">

<h5 id="Free-block-List"><a href="#Free-block-List" class="headerlink" title="Free block List"></a><strong>Free block List</strong></h5><p>List of all unallocated blocks</p>
<p>Background jobs can re-order list for better contiguity</p>
<p>Store in free blocks themselves</p>
<p>– <strong>Does not reduce disk capacity</strong></p>
<p>Only one block of pointers need be kept in the main memory</p>
<h5 id="Bit-tables"><a href="#Bit-tables" class="headerlink" title="Bit tables"></a><strong>Bit tables</strong></h5><p>Individual bits in a bit vector flags used&#x2F;free blocks</p>
<p>16GB disk with 512-byte blocks –&gt; 4MB table</p>
<p><strong>May be too large to hold in main memory</strong></p>
<p>Expensive to search</p>
<p>– Optimisations possible, e.g. a two level table</p>
<p>Concentrating (de)allocations in a portion of the bitmap has desirable effect of concentrating access</p>
<p>Simple to find contiguous free space</p>
<h3 id="Implementing-directories"><a href="#Implementing-directories" class="headerlink" title="Implementing directories"></a><strong>Implementing directories</strong></h3><p>• <strong>Directories are stored like normal files</strong></p>
<p>– directory entries are contained inside data blocks</p>
<p>• The FS assigns special meaning to the content of these files</p>
<p>– a directory file is <strong>a list of directory entries</strong></p>
<p>– a directory entry contains file name, attributes, and the file i-node number</p>
<p>• maps human-oriented file name to a system-oriented name</p>
<h3 id="Fixed-size-directory-entries"><a href="#Fixed-size-directory-entries" class="headerlink" title="Fixed-size directory entries"></a><strong>Fixed-size directory entries</strong></h3><p>– Either too small</p>
<p>• Example: DOS 8+3 characters</p>
<p>– Or waste too much space</p>
<p>• Example: 255 characters per file name</p>
<h3 id="Variable-size-directory-entries"><a href="#Variable-size-directory-entries" class="headerlink" title="Variable-size directory entries"></a><strong>Variable-size directory entries</strong></h3><p>– Freeing variable length entries can <strong>create external fragmentation</strong> in directory blocks</p>
<p>• Can compact when block is in RAM</p>
<h3 id="Searching-Directory-methods"><a href="#Searching-Directory-methods" class="headerlink" title="Searching Directory methods"></a><strong>Searching Directory methods</strong></h3><ol>
<li>Linear scan<ol>
<li>Implement a directory cache in software to speed-up search</li>
</ol>
</li>
<li>Hash lookup</li>
<li>B-tree</li>
</ol>
<h3 id="Storing-file-attributes"><a href="#Storing-file-attributes" class="headerlink" title="Storing file attributes"></a><strong>Storing file attributes</strong></h3><ol>
<li>Disk addresses and attributes in directory entry -&gt; FAT</li>
<li>Directory in which each entry just refers to an i-node -&gt; UNIX</li>
</ol>
<img src="/2023/04/26/3231note/46.png" class="" title="P35 lec09">
<h3 id="File-system-block-size"><a href="#File-system-block-size" class="headerlink" title="File system block size"></a><strong>File system block size</strong></h3><p>File systems deal with 2 types of blocks</p>
<p>– Disk blocks or sectors (usually 512 bytes)</p>
<p>– File system blocks 512 * 2^N bytes</p>
<p>What should N be will be the problem.</p>
<p>• <strong>Smaller blocks</strong> waste less disk space (<strong>less internal fragmentation</strong>)</p>
<p>• Sequential Access</p>
<p>– The larger the block size, the fewer I&#x2F;O operations required</p>
<p>• Random Access</p>
<p>– The larger the block size, the more unrelated data loaded.</p>
<p>– Spatial locality of access improves the situation</p>
<p>• Choosing an appropriate block size is a compromise</p>
<h2 id="Lec10-UNIX-File-Management-continue"><a href="#Lec10-UNIX-File-Management-continue" class="headerlink" title="Lec10 UNIX File Management (continue)"></a>Lec10 UNIX File Management (continue)</h2><h3 id="Virtual-file-system-VFS"><a href="#Virtual-file-system-VFS" class="headerlink" title="Virtual file system (VFS)"></a><strong>Virtual file system (VFS)</strong></h3><p>Traversing the directory hierarchy may require VFS to issue requests to several underlying file systems.</p>
<p>• Provides <strong>single system call interface for many file systems</strong></p>
<p>– E.g., UFS, Ext2, XFS, DOS, ISO9660,…</p>
<p>• Transparent handling of network file systems</p>
<p>– E.g., NFS, AFS, CODA</p>
<p>• File-based interface to arbitrary device drivers (&#x2F;dev)</p>
<p>• File-based interface to kernel data structures (&#x2F;proc)</p>
<p>• <strong>Provides an indirection layer for system calls</strong></p>
<p>– File operation table set up at file open time</p>
<p>– Points to actual handling code for particular type</p>
<p>– Further file operations redirected to those functions</p>
<img src="/2023/04/26/3231note/47.png" class="" title="P9 lec10">
<h3 id="Data-Types-in-VFS-Interface"><a href="#Data-Types-in-VFS-Interface" class="headerlink" title="Data Types in VFS Interface"></a><strong>Data Types in VFS Interface</strong></h3><h4 id="VFS"><a href="#VFS" class="headerlink" title="VFS"></a><strong>VFS</strong></h4><ol>
<li>Represent all file system types</li>
<li>Contains pointers to functions to manipulate each file system as a whole<ol>
<li><strong>Form a standard interface to the file system</strong></li>
</ol>
</li>
</ol>
<h4 id="Vnode"><a href="#Vnode" class="headerlink" title="Vnode"></a><strong>Vnode</strong></h4><ol>
<li>Represents a file (inode) in the underlying filesystem</li>
<li>Points to the real inode</li>
<li>Contains pointers to funcions to manipulate files&#x2F;inodes like open&#x2F;close&#x2F;read</li>
</ol>
<h3 id="File-descriptors"><a href="#File-descriptors" class="headerlink" title="File descriptors"></a><strong>File descriptors</strong></h3><h4 id="Attributes"><a href="#Attributes" class="headerlink" title="Attributes"></a><strong>Attributes</strong></h4><ol>
<li>Each open file has a file descriptor</li>
<li>Read&#x2F;Write&#x2F;Lseek&#x2F;… use them to specify which file to operate on.</li>
</ol>
<h4 id="State-associated-with-a-file-descriptor"><a href="#State-associated-with-a-file-descriptor" class="headerlink" title="State associated with a file descriptor"></a><strong>State associated with a file descriptor</strong></h4><ol>
<li>File pointer<ol>
<li>Determine where in the file the next read or write is performed</li>
</ol>
</li>
<li>Mode<ol>
<li>Was the file opened with read-only permission or sth…</li>
</ol>
</li>
</ol>
<h3 id="Use-single-fd-table-with-no-of-table"><a href="#Use-single-fd-table-with-no-of-table" class="headerlink" title="Use single fd table with no of table"></a><strong>Use single fd table with no of table</strong></h3><p>How to achieve:</p>
<p>Use vnode numbers as file descriptors and add a file pointer to the vnode.</p>
<p>Problem:</p>
<p><code>	</code><strong>Cannot handling concurrency situations</strong>.</p>
<img src="/2023/04/26/3231note/48.png" class="" title="P23 lec10">

<p>At this situation:</p>
<ol>
<li>we only have a single global open file array.</li>
<li>Entries contains file pointer and a pointer to a vnode.</li>
</ol>
<p>Issues:</p>
<p>File descriptor 1 is stdout -&gt; console for some processes but may be a file for other processes</p>
<p><strong>Entry 1 should be different different per process!</strong></p>
<h3 id="Per-process-File-descriptor-array"><a href="#Per-process-File-descriptor-array" class="headerlink" title="Per-process File descriptor array"></a><strong>Per-process File descriptor array</strong></h3><img src="/2023/04/26/3231note/49.png" class="" title="P25 lec10">

<p><strong>Each process has its own open file array</strong></p>
<h4 id="Issue"><a href="#Issue" class="headerlink" title="Issue"></a><strong>Issue</strong></h4><ol>
<li>Fork<ol>
<li>Fork defines that the child <strong>shares the file pointer</strong> with the parent</li>
</ol>
</li>
<li>Dup2<ol>
<li>Also defines the file descriptors share the file pointer</li>
</ol>
</li>
<li>With per-process table, we can <strong>only have independent file pointers</strong>, even when accessing the same file</li>
</ol>
<h3 id="Per-Process-fd-table-with-global-open-file-table"><a href="#Per-Process-fd-table-with-global-open-file-table" class="headerlink" title="Per-Process fd table with global open file table"></a><strong>Per-Process fd table with global open file table</strong></h3><img src="/2023/04/26/3231note/50.png" class="" title="P27 lec10">

<p>Per-process file descriptor array <strong>contains pointers to <em>open file table entry</em></strong></p>
<p>Open file table array <strong>contains entries with a file pointer and a pointer to an vnode</strong>.</p>
<p>This model provides</p>
<ol>
<li>Shared file pointers if required</li>
<li>Independent file pointers if required</li>
</ol>
<p><strong>This model used by linux and most other UNIX operating systems</strong></p>
<h3 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a><strong>Buffer</strong></h3><p>–Temporary storage used when <strong>transferring data between two entities</strong></p>
<p>•Especially when the entities work at different rates</p>
<p>•Or when the unit of transfer is incompatible</p>
<p>•Example: between application program and disk</p>
<h4 id="Buffer-disk-blocks"><a href="#Buffer-disk-blocks" class="headerlink" title="Buffer disk blocks"></a><strong>Buffer disk blocks</strong></h4><p>•Allow applications to <strong>work with arbitrarily sized region of a file</strong></p>
<p>–However, apps can still optimise for a particular block size</p>
<p>•Writes can return immediately after copying to kernel buffer</p>
<p>–<strong>Avoids waiting</strong> until write to disk is complete</p>
<p>–Write is <strong>scheduled in the background</strong></p>
<p>•Can implement read-ahead by pre-loading next block on disk into kernel buffer</p>
<p>–Avoids having to wait until next read is issued</p>
<h3 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a><strong>Cache</strong></h3><p>Fast storage used to temporarily hold data to speed up repeated access to the data -&gt; such as main memory can cache disk blocks</p>
<p>•On access</p>
<p>–Before loading block from disk, check if it is in cache first</p>
<p>•<strong>Avoids disk accesses</strong></p>
<p>•Can optimise for repeated access for single or several processes</p>
<h3 id="Buffer-and-caching-are-related"><a href="#Buffer-and-caching-are-related" class="headerlink" title="Buffer and caching are related"></a><strong>Buffer and caching are related</strong></h3><p>•Data is read into buffer; an extra independent </p>
<p>cache copy would be wasteful</p>
<p>•<strong>After use, block should be cached</strong></p>
<p>•Future access may hit cached copy</p>
<p>•Cache utilises unused kernel memory space; </p>
<p>–may have to shrink, depending on memory demand</p>
<h3 id="Cache-replacement"><a href="#Cache-replacement" class="headerlink" title="Cache replacement"></a><strong>Cache replacement</strong></h3><p>When the buffer cache is full and we need to read another block into memory, we must choose an existing entry to replace</p>
<p>Policies:</p>
<ol>
<li>FIFO (first in first out)</li>
<li>Least recently used</li>
</ol>
<p>Etc.</p>
<h3 id="File-system-consistency"><a href="#File-system-consistency" class="headerlink" title="File system consistency"></a><strong>File system consistency</strong></h3><p>Generally, cached disk blocks are prioritised in terms of how critical they are to file system consistency.</p>
<p>–<strong>Directory blocks, inode blocks</strong> if lost can corrupt entire filesystem</p>
<p>•These blocks are usually scheduled for <strong>immediate write to disk</strong></p>
<p>–<strong>Data blocks if lost corrupt only the file</strong> that they are associated with </p>
<p>•These blocks <strong>are only scheduled for write back to disk periodically</strong> </p>
<p>•In UNIX, flushd (flush daemon) flushes all modified blocks to disk every 30 seconds</p>
<h4 id="Possible-Solution"><a href="#Possible-Solution" class="headerlink" title="Possible Solution"></a><strong>Possible Solution</strong></h4><p>Write-through cache</p>
<ol>
<li>All modified blocks are <strong>written immediately to disk</strong></li>
</ol>
<p>But this will <strong>generate more disk traffic</strong></p>
<p>Works in the following situations:</p>
<ol>
<li>Floppies were removed from drives</li>
<li>Users were constantly resetting (or crashing) their machines</li>
</ol>
<p>This method is still be used in USB storage.</p>
<h2 id="NOT-FINISHED-YET"><a href="#NOT-FINISHED-YET" class="headerlink" title="NOT FINISHED YET"></a><strong>NOT FINISHED YET</strong></h2></div>
        </div>
        
            <div class="kratos-copyright text-center clearfix">
                <h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5>
            </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "https://xhmkggybzwmz.github.io/2023/04/26/3231note/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "https://xhmkggybzwmz.github.io/2023/04/26/3231note/";
            const title         = "「3231note」";
            const excerpt       = `UNSW COMP3231 23T1 notes`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/COMP3231/" rel="tag">COMP3231</a>
                </div>
                <div class="pull-date">
                    <time datetime="2023-04-26T14:53:02.840Z" itemprop="dateModified">最后编辑：2023-04-27</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" test for categories" href="/2023/03/21/test-for-cat/">&lt; 上一篇</a>
            </div>
            
            
        </nav>
    
    
        <link rel="stylesheet" href="/vendors/gitalk@1.7.2/dist/gitalk.css"></script>
<div id="gitalk-container" class="post-comments lazy-load" style="padding-left:2rem; padding-right:2rem;"></div>
<script>
    var load_comm = () => {
        const init = () => {
            console.log('Gitalk loading...');
            const gitalk = new Gitalk(Object.assign({
                id: '/2023/04/26/3231note/',
                path: '/2023/04/26/3231note/'
            }, JSON.parse('{"clientID":"5f6c1e1e029fb52b7652","clientSecret":"48ba85488eff7bb997fd77d4ffb2c741c86e09ab","repo":"blog_comments","owner":"xhmkggybzwmz","admin":["xhmkggybzwmz"],"distractionFreeMode":false}')));

            gitalk.render('gitalk-container');
        }
        if (typeof Gitalk === 'undefined') {
            const src = '/vendors/gitalk@1.7.2/dist/gitalk.min.js';
            $.getScript(src, init);
        } else {
            init();
        }
    };
</script>
<noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://github.com/gitalk/gitalk">comments powered by Gitalk.</a></noscript>
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/bornya_avatar.webp" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center"></p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                3
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                2
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                2
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                    <aside id="krw-toc" class="widget widget-kratos-toc clearfix toc-div-class" >
    <div class="photo-background"></div>
    <h4 class="widget-title no-after">
        <i class="fa fa-compass"></i>
        文章目录
        <span class="toc-progress-bar" role="progressbar" aria-label="阅读进度："></span>
    </h4>
    <div class="textwidget">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Lec-02-Processes-and-Threads"><span class="toc-text">Lec 02 Processes and Threads</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Processes"><span class="toc-text">Processes:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Threads"><span class="toc-text">Threads:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Process-Termination"><span class="toc-text">Process Termination</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Process-and-Thread-States"><span class="toc-text">Process and Thread States</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Running-%E2%86%92-Ready"><span class="toc-text">Running → Ready</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Running-%E2%86%92-Blocked"><span class="toc-text">Running → Blocked</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Schedular"><span class="toc-text">Schedular</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Thread-Model"><span class="toc-text">Thread Model</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Thread-Usage"><span class="toc-text">Thread Usage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Summary-in-Threads"><span class="toc-text">Summary in Threads</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lec-03-Concurrency-and-Synchronisation"><span class="toc-text">Lec 03 Concurrency and Synchronisation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Concurrency-Example"><span class="toc-text">Concurrency Example:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Critical-Region-and-how-to-identify"><span class="toc-text">Critical Region and how to identify</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Critical-Regions-Solutions"><span class="toc-text">Critical Regions Solutions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mutual-exclusion-by-taking-turns"><span class="toc-text">Mutual exclusion by taking turns</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mutual-Exclusion-by-disabling-interrupts"><span class="toc-text">Mutual Exclusion by disabling interrupts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hardware-Support-for-mutual-exclusion"><span class="toc-text">Hardware Support for mutual exclusion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tackling-the-busy-wait-problem"><span class="toc-text">Tackling the busy-wait problem:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Producer-Consumer-Problem-bounded-buffer-problem"><span class="toc-text">Producer-Consumer Problem(bounded buffer problem)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Issues"><span class="toc-text">Issues:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Semaphores"><span class="toc-text">Semaphores</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Producer-Consumer-problem-with-semaphores"><span class="toc-text">Producer Consumer problem with semaphores:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Summarising-Semaphores"><span class="toc-text">Summarising Semaphores</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Monitor"><span class="toc-text">Monitor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Condition-Variable"><span class="toc-text">Condition Variable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Synchronisation-Primitives-in-OS-x2F-161"><span class="toc-text">Synchronisation Primitives in OS&#x2F;161</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Locks"><span class="toc-text">Locks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Semaphores-1"><span class="toc-text">Semaphores</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Condition-Variables"><span class="toc-text">Condition Variables</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Condition-Variables-and-Bounded-Buffers"><span class="toc-text">Condition Variables and Bounded Buffers</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Producer-consumer-solution-with-condition-variable"><span class="toc-text">Producer-consumer solution with condition variable</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dining-Philosophers"><span class="toc-text">Dining Philosophers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reader-and-Writer-Problem"><span class="toc-text">Reader and Writer Problem</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lec04-DeadLock"><span class="toc-text">Lec04 DeadLock</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DeadLock-amp-Resources"><span class="toc-text">DeadLock &amp; Resources</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Four-conditions-for-deadlock"><span class="toc-text">Four conditions for deadlock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deadlock-avoidance"><span class="toc-text">Deadlock avoidance</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Method-1-Ostrich-Algorithm"><span class="toc-text">Method 1: Ostrich Algorithm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Method-2-Deadlock-prevention"><span class="toc-text">Method 2: Deadlock prevention</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Attacking-the-Mutual-Exclusion-Condition-Not-feasible"><span class="toc-text">Attacking the Mutual Exclusion Condition (Not feasible)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Attacking-the-hold-and-wait-condition-request-resources-initially"><span class="toc-text">Attacking the hold and wait condition (request resources initially)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Attacking-the-No-Preemption-condition-%E6%97%A0%E4%BC%98%E5%85%88%E6%9D%83%E6%9D%A1%E4%BB%B6-take-resources-away"><span class="toc-text">Attacking the No Preemption condition(无优先权条件)(take resources away)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Attacking-the-circular-wait-condition-Order-resources"><span class="toc-text">Attacking the circular wait condition (Order resources)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Method-3-Detection-and-recovery"><span class="toc-text">Method 3: Detection and recovery</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Strategy"><span class="toc-text">Strategy:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Detection-with-Multiple-Resources-of-Each-Type"><span class="toc-text">Detection with Multiple Resources of Each Type</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Algorithm"><span class="toc-text">Algorithm</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Recovery-from-Deadlock"><span class="toc-text">Recovery from Deadlock</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Method-4-Deadlock-Avoidance"><span class="toc-text">Method 4: Deadlock Avoidance</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Safe-and-Unsafe-states"><span class="toc-text">Safe and Unsafe states</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LiveLock"><span class="toc-text">LiveLock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bankers-Algorithm"><span class="toc-text">Bankers Algorithm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Starvation"><span class="toc-text">Starvation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lec05-Processes-and-Threads-Implementation"><span class="toc-text">Lec05 Processes and Threads Implementation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MIPS-Registers"><span class="toc-text">MIPS Registers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Branching-and-Jumping"><span class="toc-text">Branching and Jumping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Process"><span class="toc-text">Process</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Memory-allocation"><span class="toc-text">Memory allocation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mode-distinguish"><span class="toc-text">Mode distinguish</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#User-level-Threads"><span class="toc-text">User-level Threads</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Pros"><span class="toc-text">Pros</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Cons"><span class="toc-text">Cons</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kernel-provided-Threads"><span class="toc-text">Kernel-provided Threads</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Cons-1"><span class="toc-text">Cons</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pros-1"><span class="toc-text">Pros</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Context-Switch"><span class="toc-text">Context Switch</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Context-Switch-Occurrence"><span class="toc-text">Context Switch Occurrence</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Context-Switch-Addition"><span class="toc-text">Context Switch Addition</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lec06-Syscalls"><span class="toc-text">Lec06 Syscalls</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Syscall-Definition"><span class="toc-text">Syscall Definition</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU-Computation-Model"><span class="toc-text">CPU Computation Model</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Privileged-mode-operation"><span class="toc-text">Privileged-mode operation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#System-call-mechanism-overview"><span class="toc-text">System call mechanism overview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Coprocessor-0-CP0"><span class="toc-text">Coprocessor 0 (CP0)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exception-management"><span class="toc-text">Exception management</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C0-status"><span class="toc-text">C0_status</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%C2%B7c0-cause"><span class="toc-text">·c0_cause</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C0-epc"><span class="toc-text">C0_epc</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hardware-Exception-handling"><span class="toc-text">Hardware Exception handling</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MIPS-System-Calls"><span class="toc-text">MIPS System Calls</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OS-x2F-161-Systems-Calls"><span class="toc-text">OS&#x2F;161 Systems Calls</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Summary-of-System-Call-in-User-Mode"><span class="toc-text">Summary of System Call in User Mode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#System-Calls-%E2%80%93-Kernel-Side"><span class="toc-text">System Calls – Kernel Side</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lec07-Computer-Hardware-Review"><span class="toc-text">Lec07 Computer Hardware Review</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory-Hierarchy"><span class="toc-text">Memory Hierarchy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cashing"><span class="toc-text">Cashing</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-cache"><span class="toc-text">CPU cache</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Performance"><span class="toc-text">Performance</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Effective-Access-Time"><span class="toc-text">Effective Access Time</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Avoid-Waiting-for-Disk-Access"><span class="toc-text">Avoid Waiting for Disk Access</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Avoid-Waiting-for-Internet-Access"><span class="toc-text">Avoid Waiting for Internet Access</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lec08-File-Management"><span class="toc-text">Lec08 File Management</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#File-Names"><span class="toc-text">File Names</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#File-Structure"><span class="toc-text">File Structure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#File-Types"><span class="toc-text">File Types</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#File-Access-Types-Patterns"><span class="toc-text">File Access Types (Patterns)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Typical-File-Operations"><span class="toc-text">Typical File Operations</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Criteria-for-File-Organization"><span class="toc-text">Criteria for File Organization</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#File-Directories"><span class="toc-text">File Directories</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hierarchical-Tree-Structured-Directory"><span class="toc-text">Hierarchical (Tree Structured) Directory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Relative-and-Absolute-Pathnames"><span class="toc-text">Relative and Absolute Pathnames</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Typical-Directory-Operations"><span class="toc-text">Typical Directory Operations</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nice-Properties-of-UNIX-naming"><span class="toc-text">Nice Properties of UNIX naming</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Access-Rights"><span class="toc-text">Access Rights</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Simultaneous-Access"><span class="toc-text">Simultaneous Access</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lec09-File-System-Internals"><span class="toc-text">Lec09 File System Internals</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UNIX-Storage-Stack"><span class="toc-text">UNIX Storage Stack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Difference-between-some-FS"><span class="toc-text">Difference between some FS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Property-of-hard-disk"><span class="toc-text">Property of hard disk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Implementing-a-file-system"><span class="toc-text">Implementing a file system</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Requirements"><span class="toc-text">Requirements</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#File-Allocation-Methods"><span class="toc-text">File Allocation Methods</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Contiguous-Allocation"><span class="toc-text">Contiguous Allocation</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Dynamic-Allocation-Strategies"><span class="toc-text">Dynamic Allocation Strategies</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#External-and-Internal-fragmentation"><span class="toc-text">External and Internal fragmentation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#External-fragmentation"><span class="toc-text">External fragmentation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Internal-fragmentation"><span class="toc-text">Internal fragmentation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Conclusion"><span class="toc-text">Conclusion</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dynamic-allocation-Linked-list-allocation"><span class="toc-text">Dynamic allocation : Linked list allocation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dynamic-Allocation-File-allocation-Table-FAT"><span class="toc-text">Dynamic Allocation: File allocation Table (FAT)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#File-allocation-table-disk-layout"><span class="toc-text">File allocation table disk layout</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dynamical-Allocation-inode-based-FS-structure"><span class="toc-text">Dynamical Allocation: inode-based FS structure</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Issues-1"><span class="toc-text">Issues:</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Free-block-List"><span class="toc-text">Free block List</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Bit-tables"><span class="toc-text">Bit tables</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Implementing-directories"><span class="toc-text">Implementing directories</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fixed-size-directory-entries"><span class="toc-text">Fixed-size directory entries</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Variable-size-directory-entries"><span class="toc-text">Variable-size directory entries</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Searching-Directory-methods"><span class="toc-text">Searching Directory methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Storing-file-attributes"><span class="toc-text">Storing file attributes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#File-system-block-size"><span class="toc-text">File system block size</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lec10-UNIX-File-Management-continue"><span class="toc-text">Lec10 UNIX File Management (continue)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Virtual-file-system-VFS"><span class="toc-text">Virtual file system (VFS)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Data-Types-in-VFS-Interface"><span class="toc-text">Data Types in VFS Interface</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#VFS"><span class="toc-text">VFS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Vnode"><span class="toc-text">Vnode</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#File-descriptors"><span class="toc-text">File descriptors</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Attributes"><span class="toc-text">Attributes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#State-associated-with-a-file-descriptor"><span class="toc-text">State associated with a file descriptor</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Use-single-fd-table-with-no-of-table"><span class="toc-text">Use single fd table with no of table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Per-process-File-descriptor-array"><span class="toc-text">Per-process File descriptor array</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Issue"><span class="toc-text">Issue</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Per-Process-fd-table-with-global-open-file-table"><span class="toc-text">Per-Process fd table with global open file table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Buffer"><span class="toc-text">Buffer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Buffer-disk-blocks"><span class="toc-text">Buffer disk blocks</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cache"><span class="toc-text">Cache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Buffer-and-caching-are-related"><span class="toc-text">Buffer and caching are related</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cache-replacement"><span class="toc-text">Cache replacement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#File-system-consistency"><span class="toc-text">File system consistency</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Possible-Solution"><span class="toc-text">Possible Solution</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NOT-FINISHED-YET"><span class="toc-text">NOT FINISHED YET</span></a></li></ol>
    </div>
</aside>
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Demo/">Demo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/notes/">notes</a><span class="category-list-count">1</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/COMP3231/" style="font-size: 0.6em;">COMP3231</a> <a href="/tags/test/" style="font-size: 0.6em;">test</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2023/04/26/3231note/"><i class="fa  fa-book"></i> 3231note</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/03/21/test-for-cat/"><i class="fa  fa-book"></i> test for categories</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/03/20/hello-world/"><i class="fa  fa-book"></i> hello-world</a>
            
          
        
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  class="ap-lrc"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        <!-- Keep for compatibility -->
                        
                        
                        
                        
                        
                        
                        
                        <li><a target="_blank" rel="nofollow" href="https://github.com/xhmkggybzwmz"><i class="fa fa-github"></i></a></li>
                        
                        <!-- New links -->
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2023 INAB 版权所有.</li>
                            <li>本站已运行<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by Xhmkggybz.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>


    <script async src="/js/candy.min.js"></script>



    <script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script>
    
    <script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script>
    <meting-js
        server="netease"
        type="playlist"
        id="708801848"
        order="random"
        fixed="true"
    >
    </meting-js>



    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>